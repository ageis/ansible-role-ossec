---
- name: Ensure OSSEC agent package is installed
  apt:
    name: ossec-hids-agent
    state: present

- name: Copy OSSEC configuration
  template:
    dest: /var/ossec/etc/
    src: ossec.conf

- stat:
    path: /var/ossec/etc/client.keys
  register: ossec_client_keys

- name: Check for pre-existing agent registration
  command: /var/ossec/bin/manage_agents -l
  register: list_agents
  changed_when: false

- name: Make sure authd is not already running on OSSEC server
  delegate_to: "{{ groups.ossec_manager | first }}"
  command: pkill ossec-authd
  ignore_errors: true
  changed_when: false
  run_once: true

- name: Start authd on OSSEC server
  delegate_to: "{{ groups.ossec_manager | first }}"
  shell: >
    /var/ossec/bin/ossec-authd
    -i {{ hostvars[inventory_hostname]['ansible_' + ossec_networking_interface]['ipv4']['address'] }}
    -p 1515 &
  async: 0
  poll: 0
  run_once: true

- name: Run agent auth (if agent is not already added)
  command: >
    /var/ossec/bin/agent-auth
    -m {{ hostvars[groups.ossec_manager[0]]['ansible_' + ossec_networking_interface]['ipv4']['address'] }}
    -p 1515
    -A {{ inventory_hostname }}
  when: not ossec_client_keys.stat.exists

- name: Restart OSSEC (client)
  service:
    name: ossec
    state: restarted

- name: Kill authd on OSSEC server
  command: pkill ossec-authd
  delegate_to: "{{ groups.ossec_manager | first }}"
  ignore_errors: true
  changed_when: false
  run_once: true

- name: Restart OSSEC (server)
  delegate_to: "{{ groups.ossec_manager | first }}"
  service:
    name: ossec
    state: restarted
  run_once: true
